<!-- Header -->
<header class="admin-header">
  <div class="header-container">
    <div class="header-left">
      <div class="logo-section">
        <img src="/SHS-main-logo.png" alt="Sorella Home Solutions Logo" class="admin-logo" />
        <h1>Blog Management</h1>
      </div>
    </div>
    <div class="header-right">
      <button (click)="logout()" class="logout-button">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
          <polyline points="16 17 21 12 16 7"></polyline>
          <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
        Logout
      </button>
    </div>
  </div>
</header>

<!-- Main Content -->
<div class="blog-management">
  <!-- Back Button -->
  <div class="back-navigation">
    <a href="/admin" class="back-link">← Back to Dashboard</a>
  </div>

  <!-- Content Header -->
  <div class="management-header">
    <div class="header-top">
      <h2>Manage Posts</h2>
      <button (click)="createNewPost()" class="btn-primary">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        New Post
      </button>
    </div>

    <div class="search-box">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
      <input
        type="text"
        [(ngModel)]="searchQuery"
        placeholder="Search posts by title, author, or category..."
        class="search-input"
      />
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="loading-spinner">
      <span class="spinner"></span>
    </div>
    <p>Loading blog posts...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-container">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="8" x2="12" y2="12"></line>
      <line x1="12" y1="16" x2="12.01" y2="16"></line>
    </svg>
    <p>{{ error }}</p>
    <button (click)="loadPosts()" class="btn-secondary">Try Again</button>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading && posts.length === 0" class="empty-state">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
    </svg>
    <h3>No blog posts yet</h3>
    <p>Start creating content by clicking the "New Post" button</p>
    <button (click)="createNewPost()" class="btn-primary">Create Your First Post</button>
  </div>

  <!-- Bulk Action Toolbar -->
  <div *ngIf="showBulkActionsMenu" class="bulk-actions-toolbar">
    <div class="bulk-left">
      <span class="selected-count">{{ selectedCount }} item{{ selectedCount !== 1 ? 's' : '' }} selected</span>
    </div>

    <div class="bulk-right">
      <!-- Bulk Action Message -->
      <div *ngIf="bulkActionMessage" class="bulk-message" [class.success]="!bulkActionMessage.includes('✗')" [class.error]="bulkActionMessage.includes('✗')">
        {{ bulkActionMessage }}
      </div>

      <!-- Bulk Publish -->
      <button 
        (click)="bulkPublish()"
        [disabled]="bulkActionInProgress"
        class="bulk-btn bulk-publish"
        title="Publish selected posts"
      >
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 5v14M5 12l7 7 7-7"></path>
        </svg>
        Publish
      </button>

      <!-- Bulk Unpublish -->
      <button 
        (click)="bulkUnpublish()"
        [disabled]="bulkActionInProgress"
        class="bulk-btn bulk-unpublish"
        title="Unpublish selected posts"
      >
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 19V5M5 12l7-7 7 7"></path>
        </svg>
        Unpublish
      </button>

      <!-- Bulk Category Dropdown -->
      <div class="bulk-dropdown">
        <button 
          (click)="showCategorySelector = !showCategorySelector"
          [disabled]="bulkActionInProgress"
          class="bulk-btn bulk-category"
          title="Change category for selected posts"
        >
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 9l6-6 6 6"></path>
            <path d="M6 15l6 6 6-6"></path>
          </svg>
          Category
        </button>

        <div *ngIf="showCategorySelector" class="category-menu">
          <div class="category-list">
            <button 
              *ngFor="let cat of categories"
              (click)="bulkUpdateCategory(cat)"
              [disabled]="bulkActionInProgress"
              class="category-option"
            >
              {{ cat }}
            </button>
          </div>
        </div>
      </div>

      <!-- Bulk Delete -->
      <div class="bulk-delete-wrapper">
        <button 
          (click)="bulkDelete()"
          [disabled]="bulkActionInProgress"
          class="bulk-btn bulk-delete"
          [class.confirm-active]="bulkDeleteConfirm"
          title="Delete selected posts"
        >
          <span *ngIf="!bulkDeleteConfirm">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              <line x1="10" y1="11" x2="10" y2="17"></line>
              <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
            Delete
          </span>
          <span *ngIf="bulkDeleteConfirm" class="confirm-text">Are you sure?</span>
        </button>

        <div *ngIf="bulkDeleteConfirm" class="delete-confirm-buttons">
          <button 
            (click)="bulkDelete()"
            [disabled]="bulkActionInProgress"
            class="confirm-yes"
          >
            <span *ngIf="!bulkActionInProgress">Yes, Delete</span>
            <span *ngIf="bulkActionInProgress" class="spinner-mini"></span>
          </button>
          <button 
            (click)="cancelBulkDelete()"
            [disabled]="bulkActionInProgress"
            class="confirm-no"
          >
            Cancel
          </button>
        </div>
      </div>

      <!-- Clear Selection -->
      <button 
        (click)="clearBulkSelection()"
        class="bulk-btn bulk-clear"
        title="Clear selection"
      >
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>

  <!-- Posts Table -->
  <div *ngIf="!loading && posts.length > 0" class="posts-table-wrapper">
    <table class="posts-table" *ngIf="filteredPosts.length > 0">
      <thead>
        <tr>
          <th class="col-checkbox">
            <input 
              type="checkbox" 
              class="select-all-checkbox"
              [checked]="isAllSelected()"
              [indeterminate]="isIndeterminate()"
              (change)="toggleAllSelection()"
              title="Select all posts on this page"
            />
          </th>
          <th class="col-order">Order</th>
          <th class="col-title">Title</th>
          <th class="col-author">Author</th>
          <th class="col-category">Category</th>
          <th class="col-date">Date</th>
          <th class="col-views">Views</th>
          <th class="col-status">Status</th>
          <th class="col-actions">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let post of filteredPosts; let i = index" class="post-row" [class.selected]="isPostSelected(post._id)">
          <td class="col-checkbox">
            <input 
              type="checkbox" 
              class="post-checkbox"
              [checked]="isPostSelected(post._id)"
              (change)="togglePostSelection(post._id)"
            />
          </td>
          <td class="col-order">
            <div class="rank-input-wrapper">
              <input 
                type="number" 
                [(ngModel)]="manualRanks[post._id]" 
                (blur)="updatePostRank(post)"
                (keyup.enter)="updatePostRank(post)"
                min="0"
                class="rank-input"
                title="Enter rank (1 is first, 0 is last)"
              />
            </div>
          </td>
          <td class="col-title">
            <div class="title-cell">
              <img *ngIf="post.featuredImage" [src]="post.featuredImage" alt="Featured image" class="post-thumbnail" />
              <div class="title-info">
                <p class="post-title">{{ post.title }}</p>
                <p class="post-slug">{{ post.slug }}</p>
              </div>
            </div>
          </td>
          <td class="col-author">{{ post.author }}</td>
          <td class="col-category">
            <span class="category-badge">{{ post.category }}</span>
          </td>
          <td class="col-date">{{ formatDate(post.date) }}</td>
          <td class="col-views">
            <span class="views-badge">{{ post.views }}</span>
          </td>
          <td class="col-status">
            <button 
              (click)="togglePublish(post)" 
              [class.published]="post.published"
              [class.draft]="!post.published"
              class="status-toggle"
              [title]="'Click to ' + (post.published ? 'unpublish' : 'publish')"
            >
              {{ getStatusLabel(post) }}
            </button>
          </td>
          <td class="col-actions">
            <div class="action-buttons">
              <button (click)="editPost(post._id)" class="btn-icon btn-edit" title="Edit post">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
              </button>
              
              <div *ngIf="deleteConfirmId === post._id" class="delete-confirmation">
                <p>Delete this post?</p>
                <div class="confirm-buttons">
                  <button 
                    (click)="deletePost(post._id)"
                    [disabled]="deleting === post._id"
                    class="btn-icon btn-confirm"
                  >
                    <span *ngIf="deleting !== post._id">Yes</span>
                    <span *ngIf="deleting === post._id" class="spinner-mini"></span>
                  </button>
                  <button (click)="cancelDelete()" class="btn-icon btn-cancel">No</button>
                </div>
              </div>
              <button 
                *ngIf="deleteConfirmId !== post._id"
                (click)="confirmDelete(post._id, $event)" 
                class="btn-icon btn-delete" 
                title="Delete post"
              >
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  <line x1="10" y1="11" x2="10" y2="17"></line>
                  <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- No search results -->
    <div *ngIf="filteredPosts.length === 0" class="no-results">
      <p>No posts found matching "{{ searchQuery }}"</p>
      <button (click)="searchQuery = ''" class="btn-secondary">Clear search</button>
    </div>
  </div>

  <!-- Modal Component -->
  <app-modal></app-modal>
</div>